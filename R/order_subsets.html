<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-07-11 Sat 11:47 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Order subsets of columns</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Paul Serafini" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../theme.css">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<div class='top-bar'>
        <b class='pagetitle'>Analytics^2</b>
        <br class='rwd-break'>
        <b class='headerlinks'>
                <a class='headerlink' href='../R/index.html'>R</a>
                <a class='headerlink' href='../statistics/index.html'>Statistics</a>
                <a class='headerlink' href='../emacs/index.html'>Emacs</a>
                <a class='headerlink' href='../about/index.html'>About</a>
        </b>
</div>
</div>
<div id="content">
<h1 class="title">Order subsets of columns</h1>
<p>
I recently worked with a dataset with the following structure:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Outcome 1</td>
<td class="org-left">Outcome 1</td>
<td class="org-left">Outcome 1</td>
<td class="org-left">Outcome 2</td>
<td class="org-left">Outcome 2</td>
<td class="org-left">Outcome 2</td>
</tr>

<tr>
<td class="org-left">Mean</td>
<td class="org-left">N</td>
<td class="org-left">SD</td>
<td class="org-left">Mean</td>
<td class="org-left">N</td>
<td class="org-left">SD</td>
</tr>
</tbody>
</table>

<p>
I wanted to sort the second row within each category in the first row.
My general approach was to subset the data according to the first row, then reorder it based on the second row, then reassemble the subsets.
Because the order I wanted was not alphabetical (I wanted "N", then "Mean", then "SD"), I chose to use regular expressions to order the subsets.
</p>

<p>
The <code>order_subsets</code> function is given the dataset (<code>dat</code>), as well as the row indices for the top level row (<code>row1</code>) and the lower level row (<code>row2</code>).
To start, I
</p>

<ol class="org-ol">
<li>Create a vector of unique elements in the top level row</li>
<li>Initialize an empty list to hold each subset after I reorder it</li>
<li>Define a list of regular expressions in the order that I want to impose on the subsets</li>
</ol>

<div class="org-src-container">
<pre class="src src-R">cats &lt;- unique(dat[row1, ])
subsets &lt;- list()
regex_seq &lt;- c("_N$", "_Mean$", "_SD$")
</pre>
</div>

<p>
Then, I iterate over the indices (<code>i</code>) from 1 to the number of top level categories.
For each iteration, I
</p>
<ol class="org-ol">
<li>Subset the columns where the value in the top-level row is equal to the i<sup>th</sup> category</li>
<li>Reorder the subset's indices according to the regular expression sequence I defined above</li>
<li>Reorder the subset using the ordered indices, and add it to the empty list I initialized above</li>
</ol>

<p>
In step 1 I use the <code>drop=FALSE</code> argument to ensure that, if the subset is a single column, it isn't reduce to a vector.
</p>

<div class="org-src-container">
<pre class="src src-R">for (i in seq_along(cats)) {
    subset &lt;- dat[, dat[row1, ] == cats[i], drop=FALSE]
    indices &lt;- order_by_regex(subset[row2, ], regex_seq)
    subsets[[i]] &lt;- subset[, indices]
}
</pre>
</div>

<p>
Reordering the indices (the second step) is accomplished by another function, <code>order_by_regex</code>, which is given a vector containing the second row of the current subset (<code>row2</code>) and a vector of regular expressions (<code>regex</code>).
</p>

<p>
The first step in this function is to
</p>

<ol class="org-ol">
<li>Create a list containing one vector of indices for each regular expression, the indices corresponding to the elements of the second row with a match that regular expression</li>
<li>Remove from the list any empty vectors, to prevent errors later on</li>
</ol>

<div class="org-src-container">
<pre class="src src-R">matched_indices &lt;- sapply(regex, function(i) which(grepl(i, row2)))
matched_indices &lt;- matched_indices[lapply(matched_indices,length) &gt; 0]
</pre>
</div>

<p>
The next step is to
</p>

<ol class="org-ol">
<li>Create a vector of all the indices of the second row</li>
<li>Create a list containing the index of every element not matched by a regular expression</li>
</ol>

<div class="org-src-container">
<pre class="src src-R">all_indices &lt;- 1:length(row2)
leftover &lt;- all_indices[!all_indices %in% matched_indices]
</pre>
</div>

<p>
Then, I combine the list of matched and unmatched indices and return it. I use unlist to ensure that the result is a vector.
</p>

<div class="org-src-container">
<pre class="src src-R">unlist(c(matched_indices, leftover))
</pre>
</div>

<p>
Returning to the <code>order_subsets</code> function, after this process has been applied to every top-level category I reassemble the data frame and return it.
</p>

<div class="org-src-container">
<pre class="src src-R">do.call(cbind, subsets)
</pre>
</div>

<p>
The code in its entirety is presented below.
</p>

<div class="org-src-container">
<pre class="src src-R">order_subsets &lt;- function(dat, row1, row2) {

    cats &lt;- unique(dat[row1, ])
    subsets &lt;- list()
    regex_seq &lt;- c("_N$", "_Mean$", "_SD$")

    for (i in seq_along(cats)) {
	subset &lt;- dat[, dat[row1, ] == cats[i], drop=FALSE]
	indices &lt;- order_by_regex(subset[row2, ], regex_seq)
	subsets[[i]] &lt;- subset[, indices]
    }

    do.call(cbind, subsets)
}

order_by_regex &lt;- function(row2, regex) {

    matched_indices &lt;- sapply(regex, function(i) which(grepl(i, row2)))
    matched_indices &lt;- matched_indices[lapply(matched_indices,length) &gt; 0]

    all_indices &lt;- 1:length(row2)
    leftover &lt;- all_indices[!all_indices %in% matched_indices]

    unlist(c(matched_indices, leftover))
}

row1 &lt;- c("one", "two", "a", "a", "a", "b", "b", "b")
row2 &lt;- c("a", "c", "c_SD", "b_Mean", "a_N", "b_N", "a_SD", "c_Mean")
dat &lt;- rbind(row1, row2)

order_subsets(dat, 1, 2)
</pre>
</div>

<pre class="example">
     [,1]  [,2]  [,3]  [,4]     [,5]   [,6]  [,7]     [,8]  
row1 "one" "two" "a"   "a"      "a"    "b"   "b"      "b"   
row2 "a"   "c"   "a_N" "b_Mean" "c_SD" "b_N" "c_Mean" "a_SD"
</pre>
</div>
<div id="postamble" class="status">
<div class='bottom-bar'>
        <div class='right-align'>
                <font class='bottom-text'>Created using</font>
                <a href='https://www.gnu.org/software/emacs/' class='bottom-link'>Emacs</a>
                <font class='bottom-text'>and </font>
                <a href='https://orgmode.org/' class='bottom-link'>Org Mode</a>
        </div>
</div>
</div>
</body>
</html>
